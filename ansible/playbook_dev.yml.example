---
- name: Build development system
  hosts: all
  become: true
  vars_files:
    - vars/settings_dev.yml

  pre_tasks:

    - name: 'Replace sources.list'
      copy: "dest=/etc/apt/sources.list backup=true src=files/ubuntu-14.04_sohu_sources.list"
      when: ansible_distribution == 'Ubuntu' and ansible_distribution_release == 'trusty'
      tags: system

    - name: 'Update apt cache (Debian)'
      apt: update_cache=yes cache_valid_time=86400
      when: ansible_os_family == 'Debian'
      tags: system

    - name: 'Upgrade all packages (Debian)'
      apt: upgrade=dist
      when: ansible_os_family == 'Debian'
      tags: system

  roles:
    - role: geerlingguy.ntp
      tags: ntp
      ntp_timezone: "{{ time_zone }}"
      ntp_servers:
        - cn.pool.ntp.org iburst

    - role: geerlingguy.git
      tags: git

    - role: geerlingguy.mysql
      tags: mysql
      mysql_packages:
        - mariadb-client
        - mariadb-server
        - python-mysqldb
        - libmysqlclient-dev
      mysql_bind_address: '127.0.0.1'
      mysql_databases:
        - name: "{{ db.database }}"
      mysql_users:
        - name: "{{ db.username }}"
          host: "%"
          password: "{{ db.password }}"
          priv: "{{ db.database }}.*:ALL"
      when: ansible_os_family == 'Debian' and db.adapter == 'mysql2'

    - role: geerlingguy.redis
      tags: redis
      redis_port: '127.0.0.1'
      redis_bind_interface: "{{ redis.host }}"

    - role: geerlingguy.ruby
      tags: ruby
      ruby_install_from_source: True
      ruby_version: 2.2.2
      # ruby_download_url: http://cache.ruby-lang.org/pub/ruby/2.2/ruby-2.2.2.tar.gz
      ruby_download_url: https://ruby.taobao.org/mirrors/ruby/2.2/ruby-2.2.2.tar.gz

    - role: geerlingguy.nodejs
      tags: nodejs
      nodejs_forever: False

    - role: vkill.ssh_bastion_host
      tags: bastion_host
      sbh_user_name: "{{ local_bastion_host.user_name }}"
      sbh_user_ssh_key_public_file: "{{ local_bastion_host.user_ssh_key_public_file }}"
      sbh_user_ssh_key_private_file: "{{ local_bastion_host.user_ssh_key_private_file }}"

  tasks:
    - name: 'Replace gem source without become'
      shell: gem sources --add https://gems.ruby-china.org/ --remove https://rubygems.org/
      become: False
      tags: ruby

    - name: 'Replace gem source with become'
      shell: gem sources --add https://gems.ruby-china.org/ --remove https://rubygems.org/
      become: True
      tags: ruby

    - name: 'Replace bundle source without become'
      shell: bundle config mirror.https://rubygems.org https://gems.ruby-china.org
      become: False
      tags: ruby

    - name: 'Replace bundle source with become'
      shell: bundle config mirror.https://rubygems.org https://gems.ruby-china.org
      become: True
      tags: ruby

    - name: 'Replace npm registry without become'
      shell: npm config set registry https://registry.npm.taobao.org
      become: False
      tags: nodejs

    - name: 'Replace npm registry with become'
      shell: npm config set registry https://registry.npm.taobao.org
      become: True
      tags: nodejs



